<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBD Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- KaTeX for professional math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-sCutEFUTflVCCAiUaCfH3ggscL+dyFcCAlJjkC+AyVHt2K+k/cRdS_W1_2gE1DkC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoI8I1ds1Zm2i1j8N3bDU9HSdEVs+nsw2FcS2BAbj36G0HSCg4_PC0d2js12Ln7" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GpZv7MmrJCR5gWBbXmbP2hIgpPFeTcNPINMTC55TrP6dEAcU" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-color: #F8F9F5;
            --text-color: #064E3B;
            --subtle-text-color: #374151;
            --placeholder-color: #6B7280;
            --border-color: #E5E7EB;
            --accent-color: #10B981;
            --sidebar-bg: #FFFFFF;
            
            --button-bg: #FFFFFF;
            --button-border: #D1D5DB;
            --button-hover-bg: #F9FAFB;

            --send-button-bg: #065F46;
            --send-button-hover-bg: #047857;

            --user-msg-bg: #E5E7EB;
            --user-msg-text: #1F2937;
            --ai-msg-bg: #D1FAE5;
            --ai-msg-text: #064E3B;
            
            --danger-color: #f43f5e;
        }
        
        html[data-theme='dark'] {
            --bg-color: #111827;
            --text-color: #E5E7EB;
            --subtle-text-color: #9CA3AF;
            --placeholder-color: #6B7280;
            --border-color: #374151;
            --sidebar-bg: #1F2937;
            
            --button-bg: #1F2937;
            --button-border: #374151;
            --button-hover-bg: #374151;

            --send-button-bg: #059669;
            --send-button-hover-bg: #10B981;

            --user-msg-bg: #374151;
            --user-msg-text: #F9FAFB;
            --ai-msg-bg: #064E3B;
            --ai-msg-text: #D1FAE5;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Custom Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #BDBDBD; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #A5A5A5; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        
        /* Markdown & KaTeX Styles */
        .prose { color: var(--ai-msg-text); max-width: 100%; }
        .prose h1, .prose h2, .prose h3 { color: var(--ai-msg-text); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.3em; }
        .prose pre { background-color: rgba(0,0,0,0.2); color: #f9fafb; padding: 1em; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 0.9em; overflow-x: auto; }
        .prose code:not(pre > code) { background-color: rgba(0,0,0,0.2); padding: 0.2em 0.4em; margin: 0 0.1em; border-radius: 0.25rem; font-size: 0.85em; }
        .prose a { color: var(--accent-color); text-decoration: none; font-weight: 600; }
        .prose a:hover { text-decoration: underline; }
        .prose table { width: auto; font-size: 0.9em; border-collapse: collapse; }
        .prose th, .prose td { border: 1px solid var(--accent-color); padding: 0.5rem 0.75rem; }
        .prose th { background-color: rgba(0,0,0,0.1); font-weight: 600; }

        html[data-theme='dark'] .katex { color: var(--ai-msg-text); }
        
        #main-content {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1fae5' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            transition: background-image 0.3s ease;
        }
        
        html[data-theme='dark'] #main-content {
            background-image: url("data:image/svg+xml,%3Csvg width='52' height='52' viewBox='0 0 52 52' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23064e3b' fill-opacity='0.4'%3E%3Cpath d='M10 10h32v32H10z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        #message-input::placeholder { color: var(--placeholder-color); }

        .message-copy-button {
            position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.375rem;
            background-color: rgba(255, 255, 255, 0.7); color: #4B5563; border-radius: 0.375rem;
            opacity: 0; transition: all 0.2s ease-in-out;
        }
        html[data-theme='dark'] .message-copy-button { background-color: rgba(0, 0, 0, 0.5); color: #E5E7EB; }
        .group:hover .message-copy-button { opacity: 1; transform: scale(1); }
        .message-copy-button:hover { background-color: #fff; color: #000; transform: scale(1.1); }
        html[data-theme='dark'] .message-copy-button:hover { background-color: #000; color: #fff; }

        /* Responsive Sidebar Styles */
        #main-sidebar.open { transform: translateX(0); }
        #sidebar-overlay.open { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>
    <div id="app" class="relative h-full w-full animate-fade-in">
        
        <!-- Sidebar -->
        <aside id="main-sidebar" class="fixed top-0 left-0 z-40 w-80 h-full bg-[var(--sidebar-bg)] border-r border-[var(--border-color)] p-6 flex flex-col gap-y-8 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-[var(--text-color)]">TBD Chat</h1>
                <button id="sidebar-close-button" class="p-1 rounded-full text-[var(--text-color)] hover:bg-[var(--button-hover-bg)] md:hidden">
                    <!-- Icon set by JS -->
                </button>
            </div>
            
            <nav class="space-y-6">
                <div class="space-y-2">
                    <label for="subject-select" class="text-sm font-medium text-[var(--subtle-text-color)]">Teachers</label>
                    <select id="subject-select" class="w-full bg-[var(--button-bg)] border border-[var(--border-color)] rounded-md px-3 py-2 text-sm text-[var(--text-color)] focus:outline-none focus:ring-2 focus:ring-[var(--send-button-bg)] cursor-pointer"></select>
                </div>

                <div class="space-y-2">
                    <label for="model-select" class="text-sm font-medium text-[var(--subtle-text-color)]">Choose Model</label>
                    <select id="model-select" class="w-full bg-[var(--button-bg)] border border-[var(--border-color)] rounded-md px-3 py-2 text-sm text-[var(--text-color)] focus:outline-none focus:ring-2 focus:ring-[var(--send-button-bg)] cursor-pointer"></select>
                </div>
                
                <div class="space-y-2">
                    <label class="text-sm font-medium text-[var(--subtle-text-color)]">Theme</label>
                    <div class="flex items-center justify-between p-2 bg-[var(--button-bg)] border border-[var(--border-color)] rounded-md">
                        <span id="theme-label" class="text-[var(--text-color)] font-medium text-sm ml-1"></span>
                        <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-color)] focus:ring-[var(--accent-color)]" style="background-color: var(--border-color);">
                            <span class="sr-only">Toggle theme</span>
                            <span id="theme-toggle-knob" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out"></span>
                        </button>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"></div>

        <!-- Main Chat Area -->
        <div id="main-content" class="h-full w-full md:ml-80 flex flex-col">
            <header class="bg-transparent px-4 sm:px-6 py-3 flex items-center justify-between z-10 flex-shrink-0 border-b border-[var(--border-color)]">
                <div class="flex items-center gap-2">
                    <button id="menu-toggle" class="p-2 rounded-full text-[var(--text-color)] hover:bg-[var(--button-hover-bg)] md:hidden">
                        <!-- Icon set by JS -->
                    </button>
                    <h2 class="text-xl font-bold text-[var(--text-color)]">Chat</h2>
                </div>
                <button id="restart-chat-button" title="Restart Chat" class="p-2 rounded-full text-[var(--text-color)] hover:bg-[var(--button-hover-bg)] hover:text-[var(--danger-color)] transition-all">
                     <!-- Icon set by JS -->
                </button>
            </header>

            <main id="chat-window" class="flex-1 overflow-y-auto p-6 md:p-8 space-y-6 flex flex-col"></main>

            <footer class="bg-transparent px-4 md:px-6 py-4 flex-shrink-0 z-10">
                <div class="max-w-4xl mx-auto">
                    <div class="relative flex items-end bg-[var(--button-bg)] rounded-xl shadow-md ring-1 ring-inset ring-[var(--border-color)] focus-within:ring-2 focus-within:ring-[var(--send-button-bg)] transition-all">
                        <textarea id="message-input" class="w-full bg-transparent pl-4 pr-14 py-3 resize-none focus:outline-none text-[var(--text-color)] max-h-48" placeholder="Type your question here..." rows="1"></textarea>
                        <button id="send-button" class="absolute right-2.5 bottom-2.5 p-2 bg-[var(--send-button-bg)] rounded-lg text-white hover:bg-[var(--send-button-hover-bg)] disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100 active:scale-95 transform transition-all">
                            <svg class="w-5 h-5 -rotate-45" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.342 1.342l14-7a1 1 0 000-1.788l-14-7z"></path></svg>
                        </button>
                    </div>
                </div>
            </footer>
        
            <div id="bottom-decoration" class="absolute bottom-0 left-0 right-0 h-[100px] md:h-[150px] w-full pointer-events-none z-0 overflow-hidden">
                <svg viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg" class="absolute bottom-0" preserveAspectRatio="none"><path fill="#065f46" fill-opacity="1" d="M0,224L40,213.3C80,203,160,181,240,186.7C320,192,400,224,480,213.3C560,203,640,149,720,144C800,139,880,181,960,192C1040,203,1120,181,1200,165.3C1280,149,1360,139,1400,133.3L1440,128L1440,320L1400,320C1360,320,1280,320,1200,320C1120,320,1040,320,960,320C880,320,800,320,720,320C640,320,560,320,480,320C400,320,320,320,240,320C160,320,80,320,40,320L0,320Z" style="transition: fill 0.3s ease;"></path></svg>
            </div>
             <html[data-theme='dark'] #bottom-decoration path { fill: #064E3B; }
        </div>

        <div id="error-banner" class="fixed top-20 right-4 p-4 rounded-lg shadow-lg bg-[var(--danger-color)] text-white z-50 hidden transition-opacity duration-300" role="alert"></div>
    </div>

    <script>
        // --- MODEL CONFIGURATION ---
        const MODEL_CONFIGS = {
            "Gemma 3": { apiKey: "AIzaSyCEpxfkyQ6g3NJ_jVyyhfReY3X6j3acBdU", apiUrl: "https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent", type: "gemini" },
            "Gemini 2.5 Flash": { apiKey: "AIzaSyCGkTeb_Yjh7uDiwNvHSDHV7kTRkEJ2b78", apiUrl: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent", type: "gemini" },
            "Gemini 2.0 Flash": { apiKey: "AIzaSyAMCpZgTg88lCr0LIqqrQnoMpieK5eHM6M", apiUrl: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent", type: "gemini" }
        };

        // --- TEACHER PROMPTS ---
        const MATH_PROMPT_SUFFIX = "\n\n**Mandatory Formatting Rule:** For any mathematical formula, equation, or expression, use LaTeX format. Wrap block-display math with `$$...$$` and inline math with `$...$`. This is essential for proper display.";

        const TEACHER_PROMPTS = {
            "Chemistry": {
                initialEngagementMessage: "স্বাগতম তোমার নিজস্ব কেমিস্ট্রি টিচারে! আমি ‘Chemistry Teacher BD’—তোমার পড়ালেখার জন্য! তুমি NCTB বোর্ডের SSC বা HSC-এর ছাত্র? আমি আছি পাশে! চলো আজ থেকে প্রতিটি অধ্যায় বুঝে নিই। পরীক্ষা, সৃজনশীল প্রশ্ন, MCQ, বোর্ড প্রশ্ন।।।সব কিছু সহজ আর আনন্দয়ায়ক করে তুলি।",
                prompt: "You are Chemistry Teacher BD, a friendly, patient, and inspiring full-time NCTB Chemistry teacher who understands the Bangladeshi context. Your main task is to act as a personal tutor for SSC (Class 9-10) and HSC (Class 11-12) students, strictly based on NCTB textbooks. \nInstructional Guidelines: \n1. Bangladesh-Centric Curriculum Alignment: Follow NCTB textbooks only, referencing actual chapter names, learning outcomes, and board question trends. Include MCQ (with explanation), CQ (Creative questions), and Lab Practicals (Class 9-12). \n2. Response Language & Style: Explain in Bangla, using English for technical terms where needed. Use an easy, structured style, including sections like 'সংজ্ঞা (Definition)', 'উদাহরণ (Example)', and 'বোর্ড প্রশ্ন বিশ্লেষণ।' \n3. Interactive Learning Tactics: Conduct guided practice sessions, such as balancing equations and collaboratively solving board questions. Incorporate mini-quizzes and drawing exercises. \n4. Use of Examples & Analogies: Provide Bangladeshi life-based examples (e.g., Emulsification → তেল-পানি, Oxidation → টিউবওয়েলে মরিচা) and real-world metaphors (e.g., Valence electron → অতিথিদের মেহমান, Catalyst → চুলার তাপ). \n5. Chemistry Exam Strategy Coaching: Help students with mark distribution, previous 5-year board question trends, Srijonshil prosno techniques, and memory tricks (mnemonics, rhymes, acronyms). \n6. Image/Diagram Processing: Be able to interpret and explain structural formulas (name, group), reaction graphs (rate/energy analysis), and simplified IR/NMR spectrums. \n7. Engagement, Humor & Encouragement: Provide motivational messages, light chemistry jokes, and celebrate correct answers with phrases like 'অসাধারণ! তুমি নিজেই করে ফেলেছো!' \n8. Output Format: Explanations and answers should be structured and clear, primarily in Bangla with English technical terms." + MATH_PROMPT_SUFFIX
            },
            "Physics": {
                initialEngagementMessage: "স্বাগতম তোমার নিজস্ব ফিজিক্স টিচারে! আমি ‘Physics Teacher BD’—তোমার পড়ালেখার জন্য! তুমি NCTB বোর্ডের SSC বা HSC-এর ছাত্র? আমি আছি পাশে! চলো আজ থেকে প্রতিটি অধ্যায় বুঝে নিই। পরীক্ষা, সৃজনশীল প্রশ্ন, MCQ, বোর্ড প্রশ্ন।।।সব কিছু সহজ আর আনন্দয়ায়ক করে তুলি।",
                prompt: "You are Physics Teacher BD, a friendly, patient, and inspiring full-time NCTB Physics teacher who understands the Bangladeshi context. Your main task is to act as a personal tutor for SSC (Class 9-10) and HSC (Class 11-12) students, strictly based on NCTB textbooks. \nInstructional Guidelines: \n1. Bangladesh-Centric Curriculum Alignment: Follow NCTB textbooks only, referencing actual chapter names, learning outcomes, and board question trends. Include MCQ (with explanation), CQ (Creative questions), and Lab Practicals (Class 9-12). \n2. Response Language & Style: Explain in Bangla, using English for technical terms where needed. Use an easy, structured style, including sections like 'সংজ্ঞা (Definition)', 'উদাহরণ (Example)', and 'বোর্ড প্রশ্ন বিশ্লেষণ।' \n3. Interactive Learning Tactics: Conduct guided practice sessions, such as solving problems and collaboratively analyzing scenarios. Incorporate mini-quizzes and diagram-drawing exercises. \n4. Use of Examples & Analogies: Provide Bangladeshi life-based examples and real-world metaphors to explain physics concepts. \n5. Physics Exam Strategy Coaching: Help students with mark distribution, previous 5-year board question trends, Srijonshil prosno techniques, and memory tricks (mnemonics, rhymes, acronyms). \n6. Image/Diagram Processing: Be able to interpret and explain structural formulas, reaction graphs, and simplified spectrums relevant to physics. \n7. Engagement, Humor & Encouragement: Provide motivational messages, light physics jokes, and celebrate correct answers with phrases like 'অসাধারণ! তুমি নিজেই করে ফেলেছো!' \n8. Output Format: Explanations and answers should be structured and clear, primarily in Bangla with English technical terms." + MATH_PROMPT_SUFFIX
            },
            "Biology": {
                initialEngagementMessage: "স্বাগতম তোমার নিজস্ব বায়োলজি টিচারে! আমি ‘Biology Teacher BD’—তোমার পড়ালেখার জন্য! তুমি NCTB বোর্ডের SSC বা HSC-এর ছাত্র? আমি আছি পাশে! চলো আজ থেকে প্রতিটি অধ্যায় বুঝে নিই। পরীক্ষা, সৃজনশীল প্রশ্ন, MCQ, বোর্ড প্রশ্ন।।।সব কিছু সহজ আর আনন্দয়ায়ক করে তুলি।",
                prompt: "You are Biology Teacher BD, a friendly, patient, and inspiring full-time NCTB Biology teacher who understands the Bangladeshi context. Your main task is to act as a personal tutor for SSC (Class 9-10) and HSC (Class 11-12) students, strictly based on NCTB textbooks. \nInstructional Guidelines: \n1. Bangladesh-Centric Curriculum Alignment: Follow NCTB textbooks only, referencing actual chapter names, learning outcomes, and board question trends. Include MCQ (with explanation), CQ (Creative questions), and Lab Practicals (Class 9-12). \n2. Response Language & Style: Explain in Bangla, using English for technical terms where needed. Use an easy, structured style, including sections like 'সংজ্ঞা (Definition)', 'উদাহরণ (Example)', and 'বোর্ড প্রশ্ন বিশ্লেষণ।' \n3. Interactive Learning Tactics: Conduct guided practice sessions, such as analyzing biological processes and collaboratively solving problems. Incorporate mini-quizzes and diagram-drawing exercises. \n4. Use of Examples & Analogies: Provide Bangladeshi life-based examples and real-world metaphors to explain biological concepts. \n5. Biology Exam Strategy Coaching: Help students with mark distribution, previous 5-year board question trends, Srijonshil prosno techniques, and memory tricks (mnemonics, rhymes, acronyms). \n6. Image/Diagram Processing: Be able to interpret and explain biological diagrams (e.g., cell structures, physiological processes), and charts. \n7. Engagement, Humor & Encouragement: Provide motivational messages, light biology jokes, and celebrate correct answers with phrases like 'অসাধারণ! তুমি নিজেই করে ফেলেছো!' \n8. Output Format: Explanations and answers should be structured and clear, primarily in Bangla with English technical terms."
            },
            "BGS": {
                initialEngagementMessage: "স্বাগতম তোমার নিজস্ব বাংলাদেশ ও বিশ্বপরিচয় টিচারে! আমি ‘বাংলাদেশ ও বিশ্বপরিচয় Teacher BD’—তোমার পড়ালেখার জন্য! তুমি NCTB বোর্ডের SSC বা HSC-এর ছাত্র? আমি আছি পাশে! চলো আজ থেকে প্রতিটি অধ্যায় বুঝে নিই। পরীক্ষা, সৃজনশীল প্রশ্ন, MCQ, বোর্ড প্রশ্ন।।।সব কিছু সহজ আর আনন্দয়ায়ক করে তুলি।",
                prompt: "You are 'বাংলাদেশ ও বিশ্বপরিচয় Teacher BD', a friendly, patient, and inspiring full-time NCTB 'বাংলাদেশ ও বিশ্বপরিচয়' teacher who understands the Bangladeshi context. Your main task is to act as a personal tutor for SSC (Class 9-10) and HSC (Class 11-12) students, strictly based on NCTB textbooks. \nInstructional Guidelines: \n1. Bangladesh-Centric Curriculum Alignment: Follow NCTB textbooks only, referencing actual chapter names, learning outcomes, and board question trends. Include MCQ (with explanation), CQ (Creative questions), and relevant analytical exercises. \n2. Response Language & Style: Explain in Bangla, using English for technical terms where needed. Use an easy, structured style, including sections like 'সংজ্ঞা (Definition)', 'উদাহরণ (Example)', and 'বোর্ড প্রশ্ন বিশ্লেষণ।' \n3. Interactive Learning Tactics: Conduct guided practice sessions, such as discussing historical events, analyzing social issues, and collaboratively solving problems. Incorporate mini-quizzes and map/diagram analysis exercises. \n4. Use of Examples & Analogies: Provide Bangladeshi life-based examples and real-world metaphors to explain concepts related to history, geography, civics, and economics. \n5. Exam Strategy Coaching: Help students with mark distribution, previous 5-year board question trends, Srijonshil prosno techniques, and memory tricks (mnemonics, rhymes, acronyms) relevant to the subject. \n6. Image/Diagram Processing: Be able to interpret and explain maps, charts, graphs, and historical images relevant to 'বাংলাদেশ ও বিশ্বপরিচয়'. \n7. Engagement, Humor & Encouragement: Provide motivational messages, light subject-related anecdotes, and celebrate correct answers with phrases like 'অসাধারণ! তুমি নিজেই করে ফেলেছো!' \n8. Output Format: Explanations and answers should be structured and clear, primarily in Bangla with English technical terms."
            },
            "English": {
                initialEngagementMessage: "Welcome to your personal English Teacher! I'm 'English Teacher BD'—here to help you excel in your studies! Are you an SSC or HSC student following the NCTB board? I'm here to assist you! Let's make every chapter understandable, from paragraphs, emails, letters, and dialogues to grammar... let's make everything easy and enjoyable.",
                prompt: "You are English Teacher BD, a friendly, patient, and inspiring full-time NCTB English teacher who understands the Bangladeshi context. Your main task is to act as a personal tutor for SSC (Class 9-10) and HSC (Class 11-12) students, strictly based on NCTB textbooks. You specialize in guiding students through writing components like Paragraphs, Emails, Letters, Dialogues, and improving their grammar skills. \nInstructional Guidelines: \n1. Bangladesh-Centric Curriculum Alignment: Follow NCTB English textbooks only, referencing actual syllabus requirements and board question trends. Focus on practical application for writing components and clear grammar rules. \n2. Response Language & Style: All explanations and core teaching should be in English. Use an easy, structured style, including sections like 'Rule,' 'Example,' and 'Tips for writing/grammar.' \n3. Interactive Learning Tactics: Conduct guided practice sessions for writing, such as brainstorming for paragraphs, structuring emails, or drafting dialogues. Provide exercises for grammar concepts and collaborative problem-solving for common errors. \n4. Use of Examples & Analogies: Provide contextually relevant examples for writing topics and simple analogies to explain complex grammar rules. \n5. English Exam Strategy Coaching: Help students with mark distribution for writing sections, analyze previous 5-year board question trends, teach techniques for creative writing, and offer memory tricks for grammar rules and vocabulary. \n6. Writing Component Specifics: Paragraph - Guide on topic sentences, supporting details, coherence, and unity. Email/Letter - Focus on appropriate format, salutations, body content, and closings for different purposes (formal/informal). Dialogue - Guide on natural conversation flow, character voice, and punctuation. \n7. Grammar Specifics: Explain fundamental grammar topics (e.g., Tenses, Parts of Speech, Sentence Structure, Voice, Narration, Articles, Prepositions) with clear rules and practice exercises. \n8. Engagement, Humor & Encouragement: Provide motivational messages, light language-related anecdotes, and celebrate correct answers/improved writing with phrases like 'Excellent! Your writing has significantly improved!' or 'You've understood that very well!' \n9. Output Format: Explanations, rules, and examples should be structured and clear. Writing tasks should be guided step-by-step, and grammar exercises provided with explanations. All responses will be in English."
            },
            "Higher Math": {
                initialEngagementMessage: "স্বাগতম তোমার নিজস্ব উচ্চতর গণিত টিচারে! আমি ‘Higher Math Teacher BD’—তোমার পড়ালেখার জন্য! তুমি NCTB বোর্ডের SSC বা HSC-এর ছাত্র? আমি আছি পাশে! চলো আজ থেকে প্রতিটি অধ্যায় বুঝে নিই। পরীক্ষা, সৃজনশীল প্রশ্ন, MCQ, বোর্ড প্রশ্ন।।।সব কিছু সহজ আর আনন্দয়ায়ক করে তুলি।",
                prompt: "You are Higher Math Teacher BD, a friendly, patient, and inspiring full-time NCTB Higher Math teacher who understands the Bangladeshi context. Your main task is to act as a personal tutor for SSC (Class 9-10) and HSC (Class 11-12) students, strictly based on NCTB textbooks. \nInstructional Guidelines: \n1. Bangladesh-Centric Curriculum Alignment: Follow NCTB textbooks only, referencing actual chapter names, learning outcomes, and board question trends. Include MCQ (with explanation), CQ (Creative questions), and practical applications. \n2. Response Language & Style: Explain in Bangla, using English for technical terms where needed. Use an easy, structured style, including sections like 'সূত্র (Formula)', 'উদাহরণ (Example)', and 'বোর্ড প্রশ্ন বিশ্লেষণ।' \n3. Interactive Learning Tactics: Conduct guided practice sessions, such as step-by-step problem solving for algebra, geometry, trigonometry, and calculus. Incorporate mini-quizzes and proof-based exercises. \n4. Use of Examples & Analogies: Provide real-world examples to make abstract concepts tangible (e.g., vectors in navigation, trigonometry in construction). \n5. Exam Strategy Coaching: Help students with mark distribution, previous 5-year board question trends, Srijonshil prosno techniques, and memory tricks for formulas and theorems. \n6. Image/Diagram Processing: Be able to interpret and explain graphs of functions, geometric figures, and vector diagrams. \n7. Engagement, Humor & Encouragement: Provide motivational messages, light math-related puzzles, and celebrate correct answers with phrases like 'চমৎকার! তুমি গণিতের যুক্তিটা ধরে ফেলেছো!' \n8. Output Format: Explanations and answers should be structured and clear, primarily in Bangla with English technical terms." + MATH_PROMPT_SUFFIX
            }
        };

        // --- GLOBAL STATE & DOM REFERENCES ---
        let messages = [];
        let selectedModel = Object.keys(MODEL_CONFIGS)[0];
        let systemPrompt = null;
        
        const dom = {
            chatWindow: document.getElementById('chat-window'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            modelSelect: document.getElementById('model-select'),
            subjectSelect: document.getElementById('subject-select'),
            restartChatButton: document.getElementById('restart-chat-button'),
            themeToggle: document.getElementById('theme-toggle'),
            errorBanner: document.getElementById('error-banner'),
            themeToggleKnob: document.getElementById('theme-toggle-knob'),
            themeLabel: document.getElementById('theme-label'),
            mainSidebar: document.getElementById('main-sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggle: document.getElementById('menu-toggle'),
            sidebarCloseButton: document.getElementById('sidebar-close-button'),
        };
        
        const ICONS = {
            user: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`,
            ai: `👋`,
            copy: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>`,
            copied: `<svg class="w-4 h-4 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
            restart: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 11M20 20l-1.5-1.5A9 9 0 013.5 13" /></svg>`,
            menu: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>`,
            close: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`,
        };

        // --- CORE FUNCTIONS ---
        const handleSuggestionClick = (prompt) => {
            dom.messageInput.value = prompt;
            adjustTextareaHeight();
            handleSend();
        };

        const renderWelcomeScreen = () => {
            const suggestions = [
                { icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`, text: 'AI Study Tips' },
                { icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h4a2 2 0 012 2v2M5 15h14"></path></svg>`, text: 'Future AI Careers' },
                { icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>`, text: 'Responsible AI' },
                { icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`, text: 'পরীক্ষার প্রস্তুতির টিপস' }
            ];

            let buttonsHTML = suggestions.map(s => `
                <button onclick="handleSuggestionClick('${s.text}')" class="flex items-center justify-center text-left p-4 bg-[var(--button-bg)] border border-[var(--border-color)] rounded-xl hover:bg-[var(--button-hover-bg)] hover:shadow-md transition-all duration-200 group">
                    <div class="mr-4 text-[var(--text-color)] group-hover:text-[var(--accent-color)] transition-colors">${s.icon}</div>
                    <span class="font-semibold text-md">${s.text}</span>
                </button>
            `).join('');

            dom.chatWindow.innerHTML = `
                <div class="flex-1 flex flex-col justify-center items-center text-center max-w-2xl mx-auto px-4 animate-fade-in-up">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-color)] mb-3">
                        <span class="inline-block mr-2 animate-wiggle">👋</span> Hi! I'm TBD Chat –
                    </h1>
                    <h2 class="text-3xl md:text-4xl font-semibold text-[var(--text-color)] mb-8">
                        your AI study buddy.<br/>How can I help you grow today?
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">${buttonsHTML}</div>
                </div>`;
        };
        
        const createCopyButton = (textToCopy) => {
            const copyButton = document.createElement('button');
            copyButton.className = 'message-copy-button';
            copyButton.title = 'Copy message';
            copyButton.innerHTML = ICONS.copy;
            copyButton.onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyButton.innerHTML = ICONS.copied;
                    setTimeout(() => { copyButton.innerHTML = ICONS.copy; }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy text.');
                });
            };
            return copyButton;
        };
        
        const renderMessage = (msg) => {
            const isUser = msg.sender === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `flex items-start gap-3 animate-fade-in-up ${isUser ? 'justify-end' : ''}`;
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-semibold text-lg shadow-sm ${isUser ? 'bg-gray-700 text-white order-2' : 'bg-[var(--accent-color)] text-white'}`;
            avatar.innerHTML = isUser ? ICONS.user : ICONS.ai;
            
            const msgBubble = document.createElement('div');
            msgBubble.className = `relative group p-4 rounded-xl max-w-xl md:max-w-2xl lg:max-w-4xl shadow-sm ${isUser ? 'bg-[var(--user-msg-bg)] order-1' : 'bg-[var(--ai-msg-bg)]'}`;
            
            const prose = document.createElement('div');
            prose.className = `prose ${isUser ? 'text-[var(--user-msg-text)]' : 'text-[var(--ai-msg-text)]'}`;
            
            if (msg.streaming) {
                prose.innerHTML = `<div class="flex items-center space-x-3 text-[var(--ai-msg-text)]"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Generating response...</span></div>`;
            } else {
                prose.innerHTML = marked.parse(msg.text || '');
            }
            
            msgBubble.appendChild(prose);
            msg.domElement = prose;

            // Copy button will be added after streaming and rendering is complete
            wrapper.appendChild(avatar);
            wrapper.appendChild(msgBubble);
            return wrapper;
        };
        
        const renderAllMessages = () => {
            dom.chatWindow.innerHTML = '';
            if (messages.length === 0) {
                renderWelcomeScreen();
                return;
            }
            messages.forEach(msg => dom.chatWindow.appendChild(renderMessage(msg)));
            dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
        };

        const showError = (message) => {
            dom.errorBanner.textContent = message;
            dom.errorBanner.classList.remove('hidden', 'opacity-0');
            dom.errorBanner.classList.add('opacity-100');
            setTimeout(() => {
                dom.errorBanner.classList.remove('opacity-100');
                dom.errorBanner.classList.add('opacity-0');
                setTimeout(() => dom.errorBanner.classList.add('hidden'), 300);
            }, 5000);
        };
        
        const toggleSendButton = (enable) => {
            dom.sendButton.disabled = !enable;
            dom.messageInput.disabled = !enable;
        };

        const handleSend = async () => {
            const text = dom.messageInput.value.trim();
            if (!text || dom.sendButton.disabled) return;
            
            toggleSendButton(false);
            dom.messageInput.value = '';
            adjustTextareaHeight();

            if (messages.length === 0) dom.chatWindow.innerHTML = '';

            const userMessage = { sender: 'user', text };
            messages.push(userMessage);
            dom.chatWindow.appendChild(renderMessage(userMessage));
            dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
            
            const modelConfig = MODEL_CONFIGS[selectedModel];
            const aiMessage = { sender: 'ai', text: '', streaming: true };
            messages.push(aiMessage);
            const aiMessageElement = renderMessage(aiMessage);
            dom.chatWindow.appendChild(aiMessageElement);
            dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;

            try {
                const contentsForApi = [];
                if (systemPrompt) {
                    contentsForApi.push({ role: 'user', parts: [{ text: systemPrompt }] });
                    contentsForApi.push({ role: 'model', parts: [{ text: "Understood. I will act as the specified teacher and use LaTeX for all math." }] });
                }
                const visibleHistory = messages.slice(0, -1).map(m => ({
                    role: m.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: m.text }]
                }));
                contentsForApi.push(...visibleHistory);
                
                const payload = { 
                    contents: contentsForApi, 
                    generationConfig: { temperature: 0.7 } 
                };
                
                const response = await fetch(`${modelConfig.apiUrl}?key=${modelConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok || result.error) throw new Error(result.error?.message || `HTTP Error ${response.status}`);
                
                // FIX: Sanitize the raw text from the AI to fix escaped backslashes
                aiMessage.text = (result.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.").replace(/\\\\/g, "\\");

            } catch (error) {
                aiMessage.text = `**Error:** ${error.message}`;
                console.error('API Error:', error);
                showError(error.message);
            } finally {
                aiMessage.streaming = false;
                const proseElement = aiMessage.domElement;
                const msgBubbleElement = proseElement.parentElement;
                
                proseElement.innerHTML = marked.parse(aiMessage.text);
                
                // FIX: Safely attempt to render math to prevent chat from breaking
                try {
                    if (window.renderMathInElement) {
                        renderMathInElement(proseElement, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ]
                        });
                    }
                } catch (e) {
                    console.error("KaTeX rendering failed:", e);
                }

                if (msgBubbleElement && !msgBubbleElement.querySelector('.message-copy-button')) {
                    msgBubbleElement.appendChild(createCopyButton(aiMessage.text));
                }
                
                dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
                toggleSendButton(true);
            }
        };

        const adjustTextareaHeight = () => {
            const textarea = dom.messageInput;
            textarea.style.height = 'auto';
            textarea.style.height = `${Math.min(textarea.scrollHeight, 192)}px`;
        };
        
        const setTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                dom.themeToggle.style.backgroundColor = 'var(--accent-color)';
                dom.themeToggleKnob.style.transform = 'translateX(20px)';
                dom.themeLabel.textContent = 'Dark';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                dom.themeToggle.style.backgroundColor = 'var(--button-border)';
                dom.themeToggleKnob.style.transform = 'translateX(0px)';
                dom.themeLabel.textContent = 'Light';
            }
        };

        const toggleTheme = () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        };
        
        const toggleSidebar = () => {
            dom.mainSidebar.classList.toggle('open');
            dom.sidebarOverlay.classList.toggle('open');
        };

        const startTeacherSession = (subjectKey) => {
            if (!subjectKey) return;
            
            const confirmed = confirm(`Start a new chat session with the ${subjectKey} Teacher? This will clear your current conversation.`);

            if (confirmed) {
                dom.chatWindow.style.opacity = '0';
                if(window.innerWidth < 768) {
                    toggleSidebar();
                }
                setTimeout(() => {
                    const teacher = TEACHER_PROMPTS[subjectKey];
                    systemPrompt = teacher.prompt;
                    messages = [{ sender: 'ai', text: teacher.initialEngagementMessage }];
                    renderAllMessages();
                    dom.chatWindow.style.opacity = '1';
                }, 300);
            }
            dom.subjectSelect.value = '';
        }

        const init = () => {
            Object.keys(MODEL_CONFIGS).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.innerText = name;
                dom.modelSelect.appendChild(option);
            });
            dom.modelSelect.value = selectedModel;
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.innerText = "Select a Subject...";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            dom.subjectSelect.appendChild(defaultOption);
            Object.keys(TEACHER_PROMPTS).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.innerText = name;
                dom.subjectSelect.appendChild(option);
            });

            dom.restartChatButton.innerHTML = ICONS.restart;
            dom.menuToggle.innerHTML = ICONS.menu;
            dom.sidebarCloseButton.innerHTML = ICONS.close;
            
            const preferredTheme = localStorage.getItem('theme') || 'light';
            setTheme(preferredTheme);
            
            renderAllMessages();

            dom.modelSelect.addEventListener('change', (e) => { selectedModel = e.target.value; });
            dom.subjectSelect.addEventListener('change', (e) => startTeacherSession(e.target.value));
            dom.themeToggle.addEventListener('click', toggleTheme);
            dom.restartChatButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear this conversation and end the current session?')) {
                    dom.chatWindow.style.opacity = '0';
                    setTimeout(() => {
                        messages = [];
                        systemPrompt = null;
                        renderAllMessages();
                        dom.chatWindow.style.opacity = '1';
                    }, 300)
                }
            });
            dom.sendButton.addEventListener('click', handleSend);
            dom.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            dom.messageInput.addEventListener('input', adjustTextareaHeight);
            dom.menuToggle.addEventListener('click', toggleSidebar);
            dom.sidebarOverlay.addEventListener('click', toggleSidebar);
            dom.sidebarCloseButton.addEventListener('click', toggleSidebar);

            adjustTextareaHeight();
        };

        init();
    </script>
</body>
</html>